{% extends 'base/base.html' %}
{% load static %}

{% block title %}إضافة محل حلاقة - Barber Shop{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
<style>
.map-search-container {
    margin-bottom: 15px;
}
.leaflet-control-custom {
    background: white;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
}
.leaflet-control-custom button {
    border: none;
    background: none;
    padding: 8px;
    cursor: pointer;
    font-size: 16px;
}
.leaflet-control-custom button:hover {
    background: #f0f0f0;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="form-container">
                <div class="form-header">
                    <h2><i class="fas fa-plus-circle"></i> إضافة محل حلاقة جديد</h2>
                    <p>املأ البيانات التالية لإضافة محل الحلاقة الخاص بك</p>
                </div>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_name" class="form-label">
                                    اسم المحل <span class="required">*</span>
                                </label>
                                <input type="text" name="name" id="id_name" class="form-control" required>
                                <div class="help-text">أدخل اسم محل الحلاقة</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_phone_number" class="form-label">
                                    رقم الهاتف <span class="required">*</span>
                                </label>
                                <input type="tel" name="phone_number" id="id_phone_number" class="form-control" required>
                                <div class="help-text">رقم الهاتف للتواصل مع العملاء</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_description" class="form-label">
                            وصف المحل <span class="required">*</span>
                        </label>
                        <textarea name="description" id="id_description" class="form-control" rows="4" required></textarea>
                        <div class="help-text">اكتب وصفاً مختصراً عن محل الحلاقة والخدمات المقدمة</div>
                    </div>

                    <div class="form-group">
                        <label for="id_address" class="form-label">
                            العنوان <span class="required">*</span>
                        </label>
                        <textarea name="address" id="id_address" class="form-control" rows="2" required></textarea>
                        <div class="help-text">العنوان الكامل لمحل الحلاقة</div>
                    </div>

                    <div class="form-group">
                        <label for="id_image" class="form-label">
                            صورة المحل
                        </label>
                        <input type="file" name="image" id="id_image" class="form-control" accept="image/*">
                        <div class="help-text">ارفع صورة واضحة لواجهة المحل</div>
                    </div>
                    
                    <!-- Map Container -->
                    <div class="form-group">
                        <label class="form-label">تحديد الموقع على الخريطة <span class="required">*</span></label>
                        <div id="map" data-editable="true" style="height: 400px; border-radius: 10px; border: 2px solid #e0e0e0;"></div>
                        <div class="help-text">
                            <i class="fas fa-info-circle text-primary"></i>
                            انقر على الخريطة لتحديد الموقع، أو استخدم زر "موقعي الحالي"
                        </div>
                    </div>

                    <!-- Hidden fields for latitude and longitude -->
                    <input type="hidden" name="latitude" id="id_latitude" required>
                    <input type="hidden" name="longitude" id="id_longitude" required>
                    
                    <!-- Coordinate status display -->
                    <div id="coordinate-display"></div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_opening_time" class="form-label">
                                    وقت الافتتاح <span class="required">*</span>
                                </label>
                                <input type="time" name="opening_time" id="id_opening_time" class="form-control" required>
                                <div class="help-text">وقت بداية العمل اليومي</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_closing_time" class="form-label">
                                    وقت الإغلاق <span class="required">*</span>
                                </label>
                                <input type="time" name="closing_time" id="id_closing_time" class="form-control" required>
                                <div class="help-text">وقت انتهاء العمل اليومي</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-plus"></i>
                            إضافة محل الحلاقة
                        </button>
                        
                        <a href="{% url 'accounts:barber_dashboard' %}" class="btn-cancel">
                            <i class="fas fa-times"></i>
                            إلغاء
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== SIMPLE MAP INITIALIZATION ===');
        
        // التحقق من توفر المتطلبات
        if (typeof L === 'undefined') {
            console.error('Leaflet library not loaded!');
            return;
        }
        
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
            console.error('Map container not found!');
            return;
        }
        
        // الحصول على حقول الإحداثيات
        const latInput = document.getElementById('id_latitude');
        const lngInput = document.getElementById('id_longitude');
        
        if (!latInput || !lngInput) {
            console.error('Coordinate input fields not found!');
            return;
        }
        
        console.log('All requirements met, initializing map...');
        
        // إعدادات افتراضية (القاهرة)
        const defaultLat = 30.0444;
        const defaultLng = 31.2357;
        
        // تهيئة الخريطة
        const map = L.map('map').setView([defaultLat, defaultLng], 13);
        
        // إضافة طبقة الخريطة
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // إضافة علامة قابلة للسحب
        const marker = L.marker([defaultLat, defaultLng], {
            draggable: true
        }).addTo(map);
        
        // دالة تحديث الإحداثيات
        function updateCoordinates(lat, lng) {
            console.log('=== UPDATING COORDINATES ===');
            console.log('New coordinates:', lat, lng);
            
            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);
            
            console.log('Updated latitude field:', latInput.value);
            console.log('Updated longitude field:', lngInput.value);
            
            // إظهار رسالة نجاح
            showSuccessMessage(lat, lng);
        }
        
        // دالة إظهار رسالة النجاح
        function showSuccessMessage(lat, lng) {
            const coordinateDisplay = document.getElementById('coordinate-display');
            if (coordinateDisplay) {
                coordinateDisplay.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; border: 1px solid #c3e6cb;">
                        <i class="fas fa-check-circle"></i> 
                        تم تحديد الموقع بنجاح: ${lat.toFixed(4)}, ${lng.toFixed(4)}
                    </div>
                `;
            }
        }
        
        // معالج النقر على الخريطة
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            marker.setLatLng([lat, lng]);
            updateCoordinates(lat, lng);
        });
        
        // معالج سحب العلامة
        marker.on('dragend', function(e) {
            const lat = e.target.getLatLng().lat;
            const lng = e.target.getLatLng().lng;
            
            updateCoordinates(lat, lng);
        });
        
        // إضافة زر الموقع الحالي
        const locationControl = L.control({position: 'topright'});
        locationControl.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'leaflet-control-custom');
            div.innerHTML = `
                <button type="button" onclick="getCurrentLocation()" style="
                    background: white; 
                    border: 2px solid #ccc; 
                    border-radius: 4px; 
                    padding: 8px; 
                    cursor: pointer;
                    font-size: 16px;
                " title="موقعي الحالي">
                    <i class="fas fa-crosshairs"></i>
                </button>
            `;
            return div;
        };
        locationControl.addTo(map);
        
        // دالة الحصول على الموقع الحالي
        window.getCurrentLocation = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        map.setView([lat, lng], 15);
                        marker.setLatLng([lat, lng]);
                        updateCoordinates(lat, lng);
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        alert('لا يمكن الحصول على موقعك الحالي');
                    }
                );
            } else {
                alert('المتصفح لا يدعم تحديد الموقع الجغرافي');
            }
        };
        
        console.log('Map initialized successfully!');
        
        // تحديث الإحداثيات الافتراضية
        updateCoordinates(defaultLat, defaultLng);
        
        // إضافة زر اختبار حالة الإحداثيات
        function addCoordinateTestButton() {
            const coordinateDisplay = document.getElementById('coordinate-display');
            if (coordinateDisplay) {
                const testButton = document.createElement('button');
                testButton.type = 'button';
                testButton.className = 'btn btn-info btn-sm';
                testButton.innerHTML = '<i class="fas fa-search"></i> اختبار حالة الإحداثيات';
                testButton.style.margin = '10px 0';
                
                testButton.onclick = function() {
                    const latInput = document.getElementById('id_latitude');
                    const lngInput = document.getElementById('id_longitude');
                    
                    console.log('=== COORDINATE TEST ===');
                    console.log('Lat field:', latInput);
                    console.log('Lon field:', lngInput);
                    console.log('Lat value:', latInput ? latInput.value : 'NOT FOUND');
                    console.log('Lon value:', lngInput ? lngInput.value : 'NOT FOUND');
                    
                    alert(`حالة الإحداثيات:\nخط العرض: ${latInput ? latInput.value : 'غير موجود'}\nخط الطول: ${lngInput ? lngInput.value : 'غير موجود'}`);
                };
                
                coordinateDisplay.appendChild(testButton);
            }
        }
        
        // استدعاء زر الاختبار
        addCoordinateTestButton();
    });
</script>
{% endblock %}
